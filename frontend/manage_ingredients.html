<!doctype html>

<html lang="en">
<head>
    <meta charset="utf-8">

    <title>Ingredient Manager</title>
    <meta name="description" content="An Ingredient Manager For PANTS">
    <meta name="author" content="AustinGrey">

    <link rel="stylesheet" href="css/styles.css">

    <link rel="stylesheet" href="https://unpkg.com/ag-grid-community/dist/styles/ag-grid.css">
    <link rel="stylesheet" href="https://unpkg.com/ag-grid-community/dist/styles/ag-theme-balham.css">

</head>

<body>
<h1>Ingredient Manager</h1>
<div style="display: flex;gap: 1em">
    <!-- A data grid to browse available ingredients -->
    <div style="flex:1">
        <h2>All Ingredients</h2>
        <div class="table_container">
            <div id="ingredients" class="contained_table ag-theme-balham"></div>
        </div>
    </div>

    <!-- A form to edit the given ingredient -->
    <div style="flex: 1">
        <h2>Modify Selected</h2>
        <form id="ingredient_edit_form" class="form-grid-2">
            <input type="hidden" id="selected_row_node">
            <input type="hidden" id="ingredient_uri" name="ingredient_uri">

            <label for="name">Name</label>
            <input id="name" name="name" placeholder="Grilled Cheese">

            <label for="slug">Slug</label>
            <input id="slug" name="slug" placeholder="grilled-cheese">

            <label for="description">Description</label>
            <textarea id="description" name="description" placeholder="A sandwich made with melted cheese"></textarea>

            <label for="owner">Owner</label>
            <!-- You can't modify the owner, but I'm showing it here for this proof of concept -->
            <input id="owner" disabled value="">

            <label for="tags">Tags</label>
            <input disabled id="tags" name="tags">

            <label for="serving">Serving Size</label>
            <input id="serving" name="serving" placeholder="in grams">

            <label for="introduction">Introduction</label>
            <textarea id="introduction" name="introduction"
                      placeholder="Introductory paragraph explains ingredient"></textarea>

            <label for="notes">Notes</label>
            <textarea id="notes" name="notes" placeholder="Additional information about usage, types, etc."></textarea>
        </form>
        <button onclick="edit_ingredient()">Edit</button>
    </div>
</div>
<script src="https://unpkg.com/ag-grid-community/dist/ag-grid-community.min.noStyle.js"></script>
<script>
    /**
     * Returns credentials in basic authentication suitable string
     */
    let all_ingredients = {};

    function get_basic_auth_credentials() {
        return 'Basic ' + btoa('admin:admin')
    }

    document.addEventListener('DOMContentLoaded', () => {
        // Create a grid to view the data
        let columns = [
            {headerName: "Name", field: "name"},
            {headerName: "Description", field: "description"},
            {headerName: "Serving", field: "serving"},
            {headerName: "Notes", field: "notes"},
        ];
        let grid_options = {
            columnDefs: columns,
            rowModelType: 'infinite',
            rowSelection: 'single',
            pagination: true,
            paginationAutoPageSize: true,
            // Set up the grid to paginate using the server side API
            datasource: {
                getRows: async function (params) {
                    // Get the number of requested results
                    let num_requested = params.endRow - params.startRow;

                    let api_location = new URL('http://127.0.0.1:8000/api/1/ingredient/');
                    api_location.searchParams.set('offset', params.startRow);
                    api_location.searchParams.set('limit', num_requested);

                    let response = await fetch(api_location.toString(), {
                        headers: new Headers({
                            'Authorization': get_basic_auth_credentials()
                        })
                    });
                    if (response.ok) {
                        let data = await response.json();
                        params.successCallback(data['results'], data['count'])
                    } else {
                        params.failCallback();
                    }
                }
            }
        };
        all_ingredients = new agGrid.Grid(document.querySelector('#ingredients'), grid_options);

        // Register the event to add ingredients to the recipe
        all_ingredients.gridOptions.api.addEventListener('rowSelected', args => {
            // This event fires if a row is selected OR deselected, we only care if something gets selected
            if (!args.node.selected) return;
            let ingredient = args.data;
            document.querySelector('#ingredient_uri').value = ingredient.url;
            document.querySelector('#name').value = ingredient.name;
            document.querySelector('#slug').value = ingredient.slug;
            document.querySelector('#description').value = ingredient.description;
            document.querySelector('#owner').value = ingredient.owner;
            document.querySelector('#tags').value = ingredient.tags.join(',');
            document.querySelector('#serving').value = ingredient.serving;
            document.querySelector('#introduction').value = ingredient.introduction;
            document.querySelector('#notes').value = ingredient.notes;

            // Also store a reference to this node so that we can refresh it
            document.querySelector('#selected_row_node').extra_data = {
                'ag_data': args.node
            };
        });

    });

    /**
     * Reusable function for handling errors from the api
     */
    async function handle_api_errors(response) {
        if (!response.ok) {
            throw Error(await response.text())
        }
        return response
    }

    /**
     * Updates the ingredient based on the values in the ingredients form
     */
    function edit_ingredient() {
        let form = document.querySelector('#ingredient_edit_form');
        let api = form.querySelector('#ingredient_uri').value;
        let tags = form.querySelector('[name=tags]').value.split(',');
        // Remove empty tags
        tags = tags.filter(tag => tag !== '');

        fetch(api, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': get_basic_auth_credentials()
            },
            body: JSON.stringify({
                'name': form.querySelector('[name=name]').value,
                'slug': form.querySelector('[name=slug]').value,
                'description': form.querySelector('[name=description]').value,
                // 'owner': form.querySelector('[name=owner]').value,
                'tags': tags,
                'serving': form.querySelector('[name=serving]').value,
                'introduction': form.querySelector('[name=introduction]').value,
                'notes': form.querySelector('[name=notes]').value,
            })
        })
            .then(handle_api_errors)
            .then(resp => resp.json())
            .then(resp => {
                let row_node = document.querySelector('#selected_row_node').extra_data.ag_data;
                row_node.setData(resp);
                all_ingredients.gridOptions.api.flashCells({
                    rowNodes: [row_node]
                })
            })
            .catch(reason => alert(reason))
    }
</script>
<script src="js/scripts.js"></script>
</body>
</html>